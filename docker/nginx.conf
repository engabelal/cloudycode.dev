# Automatically determine the optimal number of worker processes
# Based on available CPU cores
worker_processes auto;

# Store the PID file in /tmp to allow running as non-root
pid /tmp/nginx.pid;

events {
    # Maximum number of simultaneous connections per worker
    worker_connections 1024;
}

http {
    # Load MIME types for correct Content-Type headers
    include       /etc/nginx/mime.types;

    # Fallback content type
    default_type  application/octet-stream;

    # Enable efficient file transfers
    sendfile on;

    # Optimize packet handling
    tcp_nopush on;
    tcp_nodelay on;

    # Keep-alive timeout for persistent connections
    keepalive_timeout 65;

    # Enable gzip compression for better performance
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1024;
    gzip_vary on;

    # File types eligible for gzip compression
    gzip_types
        application/javascript
        application/json
        application/ld+json
        application/xml
        text/css
        text/javascript
        text/plain
        text/xml
        image/svg+xml;

    server {
        # Listen on port 8080 (non-root safe port)
        listen 8080;

        # Catch-all server name
        server_name _;

        # Root directory for static files
        root /usr/share/nginx/cloudycode;

        # Default file served
        index index.html;

        # -------------------------------
        # Static assets caching
        # -------------------------------
        # Cache static assets aggressively since they are versioned
        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|json)$ {
            expires 30d;
            add_header Cache-Control "public, immutable" always;
            try_files $uri =404;
        }

        # -------------------------------
        # index.html caching policy
        # -------------------------------
        # Do NOT cache index.html to allow instant SPA updates
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        }

        # -------------------------------
        # SPA routing support
        # -------------------------------
        # Forward all unknown routes to index.html
        location / {
            try_files $uri $uri/ /index.html;
        }

        # -------------------------------
        # Security headers
        # -------------------------------

        # Prevent MIME type sniffing
        add_header X-Content-Type-Options "nosniff" always;

        # Control how much referrer information is sent
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Content Security Policy
        # Restricts where content can be loaded from
        # This is a strong defense against XSS attacks
        add_header Content-Security-Policy "
            default-src 'self';
            script-src 'self';
            style-src 'self';
            img-src 'self' data:;
            font-src 'self';
            frame-ancestors 'self';
        " always;
    }
}
